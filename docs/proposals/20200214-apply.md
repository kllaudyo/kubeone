# KubeOne Reconciliation Process (`kubeone apply`)

**Author:** Marko MudriniÄ‡ ([@xmudrii](https://github.com/xmudrii))  
**Status:** **Draft** | Review | Final  
**Created:** 2020-02-14  
**Last updated:** 2020-02-14

## Abstract

KubeOne supports installing/provisioning and upgrading clusters, with repairs being
planned as well. Currently, all features are implemented as dedicated subcommands,
for example `install` and `upgrade`. Instead of having a subcommand for each feature,
we want to implement the reconciliation process under the `apply` subcommand. `apply`
would analyze the provided cluster configuration file (the expected state) and the cluster
status (the actual state), and based on the difference take the appropriate steps.
The appropriate steps can be operations such as install, upgrade, repair cluster,
apply missing manifest, create or rotate the worker nodes...

## Goals

* Implement the `apply` subcommand
  * Implement probes to detect the state of the cluster
  * Implement the logic to take the appropriate steps depending on
  the results returned by probes (e.g. install or upgrade the cluster)
* Decide on deprecating existing subcommands (`install` and `upgrade`)

## Non-goals

* Implement the repair process

## Implementation

The reconciliation process is going to be invoked by the `kubeone apply` command.
The command takes the KubeOne cluster configuration manifest, which represents the
expected state, and optionally Terraform state and set of flags and options.

Example: `kubeone apply config.yaml -t tfstate.json`

Once invoked, the command takes the following steps:
* parse the provided cluster configuration to determine the expected state
* run probes to determine the actual state of the cluster
* run specific set of actions to turn actual state into the expected state (reconcile)
* re-run probes to ensure that actual and expected states of the cluster match

### Probes

Probes are used to determine the actual state of the cluster. They are implemented
as commands to be executed on nodes or as Kubernetes API requests. For example, a 
probe can check is `kubelet` running on a node or does all required pods exist.

The following probes will be implemented:
* which nodes are provisioned and determine the leader instance
* node status and readiness,
* Kubernetes version
* status of the control plane components (API server, `controller-manager`, `kubelet`...)
* status of `etcd`
* status of worker nodes

Most of mentioned checks are already implemented in some form in `upgrade` and
`status` subcommands.

### Reconciling The Cluster

#### The Cluster Is Not Provisioned

Trigger: the probe checking is cluster provisioned returned **false**.

Action to take: install the cluster from scratch (equivalent to `kubeone install`)

Possible reasons: new cluster

## Tasks & Efforts

* TBD

## Glossary

* The leader (instance): instance that is used to run `kubeadm init` on and which is used to sync certificates with other nodes